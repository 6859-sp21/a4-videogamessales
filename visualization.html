<html>
  <head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <style> /* set the CSS */
      div.tooltip {
        position: absolute;
        text-align: left;
        width: auto;
        height: auto;
        padding: 2px;
        font: 12px sans-serif;
        /* background: lightsteelblue; */
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <h1>6.859: Video Games Sales</h1>

    <div id="chart" style="width:420px;height:420px;">
      <!-- This is where we will put our chart. -->
    </div>
    <div id="filter">
      <label for="platform"> 
        Choose a platform:
      </label>

      <select name="platform" id="platform">
        <option value="---">---</option>
        <option value="3do">3DO</option>
        <option value="3ds">3DS</option>
        <option value="2600">2600</option>
        <option value="dc">DC</option>
        <option value="ds">DS</option>
        <option value="gb">GB</option>
        <option value="gba">GBA</option>
        <option value="gc">GC</option>
        <option value="gen">GEN</option>
        <option value="gg">GG</option>
        <option value="n64">N64</option>
        <option value="nes">NES</option>
        <option value="ng">NG</option>
        <option value="pc">PC</option>
        <option value="pcfx">PCFX</option>
        <option value="ps">PS</option>
        <option value="ps2">PS2</option>
        <option value="ps3">PS3</option>
        <option value="ps4">PS4</option>
        <option value="psp">PSP</option>
        <option value="sat">SAT</option>
        <option value="scd">SCD</option>
        <option value="tg16">TG16</option>
        <option value="wii">Wii</option>
        <option value="ws">WS</option>
        <option value="x360">X360</option>
        <option value="xb">XB</option>
        <option value="xone">XOne</option>
      </select>

      <label for="genre"> 
        Choose a genre
      </label>

      <select name="genre" id="genre">
        <option value="---">---</option>
        <option value="action">Action</option>
        <option value="adventure">Adventure</option>
        <option value="fighting">Fighting</option>
        <option value="misc">Misc</option>
        <option value="platform">Platform</option>
        <option value="puzzle">Puzzle</option>
        <option value="racing">Racing</option>
        <option value="role-playing">Role-Playing</option>
        <option value="shooter">Shooter</option>
        <option value="simulation">Simulation</option>
        <option value="sports">Sports</option>
        <option value="strategy">Strategy</option>
      </select>
    </div>

    <script>
      // 1. Download data
      d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-videogamessales/main/vgsalesglobale.csv")
      .then(data => {
        // 2. Setting up variables that describe our chart's space.
      const height = 400;
      const width = 800;;
      const margin = ({top: 20, right: 60, bottom: 20, left: 60});

      const data10 = data.filter(d => d.rank <= 10);
      
      // default platform/genre values
      let platformValue = "---";
      let genreValue = "---";

      console.log(data10);

      // 3. Create a SVG we will use to make our chart.
      const svg = d3.create('svg')
        .attr('width', width)
        .attr('height', height);

      // 4. Setting up scales.
      const xScale = d3.scaleBand()
          // .domain(data10.map(d => d.rank))
          .domain([1,2,3,4,5,6,7,8,9,10])
          .range([margin.left, width - margin.right])
          .padding(0.1);
    
      const yScale = d3.scaleLinear()
          .domain([0, d3.max(data10, d => d.global_sales)])
          .range([height - margin.bottom, margin.top])
          .nice();
      
      const colorScale = d3.scaleOrdinal()
          .domain([0,10])
          .range(d3.schemeTableau10);

      //5. Draw our histogram
      // x-aixs
      svg.append('g')
        .classed('x-axis', true)
        .attr('transform', `translate(0, ${height - margin.bottom})`)
        .call(d3.axisBottom(xScale))
        .append('text')
          .attr('text-anchor', 'end')
          .attr('fill', 'black')
          .attr('font-size', '12px')
          .attr('font-weight', 'bold')
          .attr('x', width - margin.right)
          .attr('y', -10)
          .text('Ranking');
      
      // y-axis
      svg.append('g')
        .classed('y-axis', true)
        .attr('transform', `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(yScale))
        // .append('text')
        //   .attr('transform', `translate(20, ${margin.top}) rotate(-90)`)
        //   .attr('text-anchor', 'end')
        //   .attr('fill', 'black')
        //   .attr('font-size', '12px')
        //   .attr('font-weight', 'bold')
        //   .text('Total Sales');

      const g_hist = svg.append('g')
        .classed('marks', true);

      var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
      
      // draw histogram
      function dataJoinHisto(rawData) {
        g_hist.selectAll('rect')
          .data(rawData)
          .join(
            enter => enter.append("rect")
                  .attr('fill', d => colorScale(d.rank))
                  .attr('x', d => xScale(d.rank))
                  .attr('y', d => yScale(d.global_sales) - margin.bottom)
                  .attr('width', xScale.bandwidth())
                  .call(enter => enter.transition().duration(1000)
                    .attr('height', d => height - yScale(d.global_sales))),
            update => update
                  .attr('fill', d => colorScale(d.rank))
                  .attr('x', (d, i) => xScale(i + 1))
                  .attr('y', d => yScale(d.global_sales) - margin.bottom)
                  .attr('width', xScale.bandwidth())
                  .call(enter => enter.transition().duration(1000)
                    .attr('height', d => height - yScale(d.global_sales))),
            exit => exit
                  .call(exit => exit.transition().duration(1000)
                    .attr('height', d => height - yScale(0))
                    .remove())
          )
          .on("mouseover", function(event, d) {
            tooltip.transition()
              .duration(200)
              .style("opacity", .9);
            tooltip.html("Name: " + d.name + "<br/> Rank: " + d.rank + "<br/> Released Year: " + d.year
            + "<br/> Platform: " + d.platform + "<br/> Genre: " + d.genre + "<br/> Publisher: " + d.publisher)
              .style("left", (event.pageX) + "px")
              .style("background", colorScale(d.rank))
              .style("top", (event.pageY - 28) + "px");

            d3.select(this)
              .attr("opacity", .5)
              .attr("d", symbol.size(64 * 4));
          })
          .on("mouseout", function(event, d) {
            tooltip.transition()
              .duration(500)
              .style("opacity", 0);

            d3.select(this)
              .attr("opacity", 1)
              .attr("d", symbol.size(64));

            });
      }
      
      // Function to filter data based on dropdown menu values

      const filterData = (platform, genre) => {
        // function *filter(array, condition, maxSize) {
        //   if (!maxSize || maxSize > array.length) {
        //     maxSize = array.length;
        //   }
        //   let count = 0;
        //   let i = 0;
        //   while ( count< maxSize && i < array.length ) {
        //     if (condition(array[i])) {
        //       yield array[i];
        //       count++;
        //     }
        //     i++;
        //   }

        //   return [...filter(data, /*condition */, 10)]
        // }
        return data.filter(function(d) {
          if (this.count < 10 && 
              (platform === d.platform.toLowerCase() || platform === "---") && 
              (genre === d.genre.toLowerCase() || genre === "---") ) {
            this.count++;
            return true;
          }
          return false;
        }, {count: 0})
      }

      dataJoinHisto(data10); 

      document.getElementById("chart").appendChild(svg.node());
      document.getElementById("platform").addEventListener('change', (e) => {
        platformValue = e.target.value;

        let filteredData = filterData(platformValue, genreValue);
        console.log(filteredData);
        // Might need a promise here
        dataJoinHisto(filteredData);
      });
      document.getElementById("genre").addEventListener('change', (e) => {
        genreValue = e.target.value;

        let filteredData = filterData(platformValue, genreValue);
        console.log(filteredData);
        // Might need a promise here
        dataJoinHisto(filteredData);}
      );
      });
      
    </script>
  </body>

  <!-- This adapted from Arvind's observable from lecture. https://observablehq.com/d/4c93c3a516d35624 -->
  <!-- Great D3 intro resource: https://observablehq.com/@d3/learn-d3?collection=@d3/learn-d3 -->
</html>